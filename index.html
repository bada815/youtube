<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>YouTube Competitor Analysis Tool</title>
    <meta name="description" content="Analyze YouTube competitors and video performance with this tool.">
    <meta property="og:image"
        content="https://lh3.googleusercontent.com/aida-public/AB6AXuCDprc-ztABUtxrQR8tmjex1ciSWuba0ztkKF19z6no-FdNt0v74dcaxkkzYIbvxlYnTRsthm4EoiJqMlR6Pec2Kvm2ilwbKtCchb7ecCF0wRH2hzHoxWVvil2GhS8d_tN4WEdoNsM83DpQ1khNWXAwKdje30dysGtB0CDefMI0u5YUhIC4ILGX5EwyAliJYtHPWdJoXHPJcVRLVVTaE07fjY93wOUusy1ms6aJCVFcEfJOeAngxJEH35MqiW1dKXbQfAmSori59a03">

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-dark": "#1e293b",
                        "surface-light": "#ffffff",
                        "yt-red": "#FF0000",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar for sidebar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-100 flex flex-col h-screen overflow-hidden antialiased selection:bg-primary/30">
    <!-- Header -->
    <header
        class="h-16 shrink-0 z-20 flex items-center justify-between border-b border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-[#111a22] px-4 lg:px-6 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex items-center justify-center size-8 rounded-lg bg-yt-red/10 text-yt-red">
                <span class="material-symbols-outlined text-2xl">smart_display</span>
            </div>
            <h1 class="text-lg font-bold tracking-tight hidden sm:block">YT Analyzer</h1>
        </div>

        <!-- API Key Input (Visible) -->
        <div class="flex-1 max-w-sm mx-4 hidden sm:block">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="material-symbols-outlined text-slate-400 text-[18px]">key</span>
                </div>
                <input id="api-key-input" type="password"
                    class="block w-full rounded-lg border-0 py-1.5 pl-10 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary dark:bg-surface-dark dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6"
                    placeholder="Enter YouTube Data API Key">
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Language Dropdown -->
            <div class="relative group mr-2 hidden md:block">
                <button id="lang-btn"
                    class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                    <span class="material-symbols-outlined text-[20px]">language</span>
                    <span id="current-lang-label">English</span>
                    <span class="material-symbols-outlined text-[16px]">expand_more</span>
                </button>
                <div
                    class="absolute right-0 top-full mt-2 w-40 rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-right">
                    <div class="py-1">
                        <button onclick="setLanguage('en')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">English</button>
                        <button onclick="setLanguage('ko')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">한국어</button>
                        <button onclick="setLanguage('zh')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">中文</button>
                        <button onclick="setLanguage('ja')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">日本語</button>
                    </div>
                </div>
            </div>

            <button id="theme-toggle"
                class="p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 rounded-lg transition-colors">
                <span class="material-symbols-outlined">light_mode</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside
            class="w-64 shrink-0 hidden md:flex flex-col border-r border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-[#111a22]">
            <div class="p-4 flex flex-col h-full">
                <div class="mb-6">
                    <h2
                        class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 px-2 text-label-history">
                        Recent Searches
                    </h2>
                    <ul id="history-list" class="space-y-1">
                        <!-- History Items will be injected here -->
                    </ul>
                </div>
                <div class="mt-auto pt-4 border-t border-slate-200 dark:border-slate-800">
                    <button id="clear-history-btn"
                        class="flex w-full items-center justify-center gap-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-transparent px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">delete_sweep</span>
                        <span class="text-label-clear">Clear History</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark relative scroll-smooth">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

                <!-- Search Section -->
                <div class="space-y-4">
                    <div class="relative shadow-lg rounded-xl">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-slate-400 text-2xl">search</span>
                        </div>
                        <input id="search-input"
                            class="block w-full rounded-xl border-0 py-4 pl-12 pr-20 text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary dark:bg-surface-dark dark:ring-slate-700 dark:text-white text-lg shadow-sm"
                            placeholder="Analyze a keyword (e.g., 'productivity hacks') or channel..." type="text" />
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                            <button id="search-btn"
                                class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors">
                                Analyze
                            </button>
                        </div>
                    </div>

                    <!-- Usage Info -->
                    <div id="api-usage-info" class="text-xs text-slate-500 text-right hidden">
                        Quota Used: <span id="quota-used">0</span> units
                    </div>

                    <!-- Filters -->
                    <div class="flex flex-wrap items-center gap-3 pb-2 overflow-x-auto no-scrollbar">
                        <span
                            class="text-xs font-semibold text-slate-500 uppercase mr-1 text-label-filters">Filters:</span>

                        <!-- Duration Filter -->
                        <div class="relative inline-block text-left group">
                            <button id="filter-duration-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700"
                                data-filter-type="duration" data-value="any">
                                <span id="label-duration">Duration: Any</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                            <!-- Dropdown content handled by JS or simple click toggle -->
                        </div>

                        <!-- Date Filter -->
                        <div class="relative inline-block text-left group">
                            <button id="filter-date-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700"
                                data-filter-type="date" data-value="all">
                                <span id="label-date">Date: All Time</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                        </div>

                        <!-- Score Filter -->
                        <div class="relative inline-block text-left group">
                            <button id="filter-score-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700"
                                data-filter-type="score" data-value="all">
                                <span id="label-score">Score: All</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                        </div>

                        <div class="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-2"></div>
                        <button id="reset-filters-btn"
                            class="text-sm text-slate-500 hover:text-primary underline text-label-reset">Reset
                            all</button>
                    </div>
                </div>

                <!-- Results Area -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white"><span
                                class="text-label-results">Analysis Results</span> <span id="result-count"
                                class="ml-2 text-sm font-normal text-slate-500 dark:text-slate-400"></span></h2>
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <span class="text-label-sort">Sort by:</span>
                            <select id="sort-select"
                                class="bg-transparent border-none text-slate-900 dark:text-white font-medium focus:ring-0 cursor-pointer p-0 pr-6">
                                <option value="relevance">Relevance</option>
                                <option value="score_desc">Score (High to Low)</option>
                                <option value="views_desc">Views (High to Low)</option>
                                <option value="date_desc">Date (Newest)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Video Grid -->
                    <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- Videos will be injected here -->
                        <!-- Initial Skeleton for visual -->
                        <p class="col-span-full text-center text-slate-500 py-10 text-label-start-prompt">Enter a
                            keyword and your API Key to start analyzing.</p>
                    </div>
                </div>

                <!-- Footer / Ads -->
                <footer class="mt-12 border-t border-slate-200 dark:border-slate-800 pt-8 pb-4">
                    <div class="flex flex-col items-center gap-6">
                        <div
                            class="w-full max-w-[728px] min-h-[90px] bg-slate-200 dark:bg-slate-800 rounded flex items-center justify-center border border-dashed border-slate-400 text-slate-400">
                            <!-- AdSense Container -->
                            <span class="text-sm font-medium">Advertisement Space</span>
                            <!-- Insert Adsense script here if needed -->
                        </div>
                        <div class="flex items-center gap-6 text-sm text-slate-500 dark:text-slate-400">
                            <a class="hover:text-primary" href="#">Privacy Policy</a>
                            <a class="hover:text-primary" href="#">Terms of Service</a>
                            <a class="hover:text-primary" href="#">API Usage</a>
                        </div>
                        <p class="text-xs text-slate-400">© 2024 YT Analyzer. Not affiliated with YouTube.</p>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- Application Logic -->
    <script>
        /**
         * Internationalization (I18N) Dictionary
         */
        const I18N = {
            en: {
                title: "YT Analyzer",
                searchPlaceholder: "Analyze a keyword (e.g., 'productivity hacks')...",
                apiKeyPlaceholder: "Enter YouTube Data API Key",
                analyzeBtn: "Analyze",
                recentSearches: "Recent Searches",
                clearHistory: "Clear History",
                filters: "Filters:",
                durationAny: "Duration: Any",
                durationShort: "Short (< 2m)",
                durationLong: "Long (≥ 2m)",
                dateAll: "Date: All Time",
                scoreAll: "Score: All",
                resetAll: "Reset all",
                results: "Analysis Results",
                sort: "Sort by:",
                startPrompt: "Enter a keyword and your API Key to start analyzing.",
                loading: "Loading...",
                errorApiKey: "Please enter a valid API Key.",
                views: "views",
                subs: "subscribers",
                score: "Score",
                daysAgo: "days ago",
                hoursAgo: "hours ago",
                minutesAgo: "minutes ago",
                monthsAgo: "months ago",
                yearsAgo: "years ago"
            },
            ko: {
                title: "유튜브 분석기",
                searchPlaceholder: "키워드를 입력하세요 (예: '생산성 꿀팁')...",
                apiKeyPlaceholder: "YouTube Data API 키 입력",
                analyzeBtn: "분석하기",
                recentSearches: "최근 검색 기록",
                clearHistory: "기록 삭제",
                filters: "필터:",
                durationAny: "길이: 전체",
                durationShort: "숏폼 (2분 미만)",
                durationLong: "롱폼 (2분 이상)",
                dateAll: "날짜: 전체",
                scoreAll: "점수: 전체",
                resetAll: "초기화",
                results: "분석 결과",
                sort: "정렬:",
                startPrompt: "키워드와 API 키를 입력하여 분석을 시작하세요.",
                loading: "로딩 중...",
                errorApiKey: "유효한 API 키를 입력하세요.",
                views: "조회수",
                subs: "구독자",
                score: "성과 점수",
                daysAgo: "일 전",
                hoursAgo: "시간 전",
                minutesAgo: "분 전",
                monthsAgo: "개월 전",
                yearsAgo: "년 전"
            },
            zh: {
                title: "YT分析器",
                searchPlaceholder: "输入关键字进行分析...",
                apiKeyPlaceholder: "输入YouTube Data API密钥",
                analyzeBtn: "分析",
                recentSearches: "最近搜索",
                clearHistory: "清除历史",
                filters: "筛选:",
                durationAny: "时长: 全部",
                durationShort: "短视频 (< 2分)",
                durationLong: "长视频 (≥ 2分)",
                dateAll: "日期: 全部",
                scoreAll: "评分: 全部",
                resetAll: "重置",
                results: "分析结果",
                sort: "排序:",
                startPrompt: "输入关键字和API密钥以开始分析。",
                loading: "加载中...",
                errorApiKey: "请输入有效的API密钥。",
                views: "观看次数",
                subs: "订阅者",
                score: "评分",
                daysAgo: "天前",
                hoursAgo: "小时前",
                minutesAgo: "分钟前",
                monthsAgo: "个月前",
                yearsAgo: "年前"
            },
            ja: {
                title: "YT分析ツール",
                searchPlaceholder: "キーワードを入力して分析...",
                apiKeyPlaceholder: "YouTube Data APIキーを入力",
                analyzeBtn: "分析",
                recentSearches: "最近の検索",
                clearHistory: "履歴を削除",
                filters: "フィルター:",
                durationAny: "長さ: すべて",
                durationShort: "ショート (< 2分)",
                durationLong: "ロング (≥ 2分)",
                dateAll: "日付: すべて",
                scoreAll: "スコア: すべて",
                resetAll: "リセット",
                results: "分析結果",
                sort: "並び替え:",
                startPrompt: "キーワードとAPIキーを入力して分析を開始してください。",
                loading: "読み込み中...",
                errorApiKey: "有効なAPIキーを入力してください。",
                views: "回視聴",
                subs: "登録者",
                score: "スコア",
                daysAgo: "日前",
                hoursAgo: "時間前",
                minutesAgo: "分前",
                monthsAgo: "ヶ月前",
                yearsAgo: "年前"
            }
        };

        /**
         * Application State
         */
        const state = {
            apiKey: localStorage.getItem('yt_api_key') || '',
            history: JSON.parse(localStorage.getItem('yt_search_history')) || [],
            lang: localStorage.getItem('yt_lang') || 'en',
            videos: [], // Raw data from API
            filteredVideos: [],
            isDark: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches),
            filters: {
                duration: 'any', // any, short, long
                date: 'all', // all, 1m, 3m, 6m, 1y, ...
                score: 'all' // all, ranges
            },
            sortBy: 'relevance'
        };

        /**
         * DOM Elements
         */
        const els = {
            apiKeyInput: document.getElementById('api-key-input'),
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            historyList: document.getElementById('history-list'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            videoGrid: document.getElementById('video-grid'),
            resultCount: document.getElementById('result-count'),
            sortSelect: document.getElementById('sort-select'),
            themeToggle: document.getElementById('theme-toggle'),
            langBtn: document.getElementById('lang-btn'),
            currentLangLabel: document.getElementById('current-lang-label'),
            quotaUsed: document.getElementById('quota-used'),
            apiUsageInfo: document.getElementById('api-usage-info'),

            // Filters
            filterDurationBtn: document.getElementById('filter-duration-btn'),
            filterDateBtn: document.getElementById('filter-date-btn'),
            filterScoreBtn: document.getElementById('filter-score-btn'),
            resetFiltersBtn: document.getElementById('reset-filters-btn'),

            // Labels for I18N
            labelDuration: document.getElementById('label-duration'),
            labelDate: document.getElementById('label-date'),
            labelScore: document.getElementById('label-score'),
        };

        /**
         * Utiltity Functions
         */

        function saveState() {
            localStorage.setItem('yt_api_key', state.apiKey);
            localStorage.setItem('yt_search_history', JSON.stringify(state.history));
            localStorage.setItem('yt_lang', state.lang);
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const t = I18N[state.lang];

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " " + t.yearsAgo;
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " " + t.monthsAgo;
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " " + t.daysAgo;
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " " + t.hoursAgo;
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " " + t.minutesAgo;
            return "Just now";
        }

        function parseDuration(duration) {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const hours = (parseInt(match[1]) || 0);
            const minutes = (parseInt(match[2]) || 0);
            const seconds = (parseInt(match[3]) || 0);

            const totalSeconds = hours * 3600 + minutes * 60 + seconds;

            let formatted = "";
            if (hours > 0) formatted += hours + ":";
            formatted += (minutes < 10 && hours > 0 ? "0" : "") + minutes + ":";
            formatted += (seconds < 10 ? "0" : "") + seconds;

            if (hours === 0 && minutes === 0) formatted = "0:" + (seconds < 10 ? "0" : "") + seconds;

            return {
                formatted,
                totalSeconds
            };
        }

        function calculateScore(views, subs) {
            if (!subs || subs === 0) return 0;
            return ((views / subs) * 100).toFixed(1);
        }

        /**
         * Initialization & Event Listeners
         */
        function init() {
            // Restore State
            els.apiKeyInput.value = state.apiKey;
            if (state.isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');

            updateLanguage(state.lang);
            renderHistory();

            // Event Listeners
            els.apiKeyInput.addEventListener('change', (e) => {
                state.apiKey = e.target.value.trim();
                saveState();
            });

            els.searchBtn.addEventListener('click', () => performSearch(els.searchInput.value));
            els.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch(els.searchInput.value);
            });

            els.clearHistoryBtn.addEventListener('click', () => {
                state.history = [];
                saveState();
                renderHistory();
            });

            els.themeToggle.addEventListener('click', () => {
                state.isDark = !state.isDark;
                if (state.isDark) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });

            els.sortSelect.addEventListener('change', (e) => {
                state.sortBy = e.target.value;
                applyFiltersAndRender();
            });

            // Filter Toggles (Simple cycling for demo, or full UI in real app)
            // For simplicity in this single file, clicking a filter cycles through options

            // Duration: Any -> Short -> Long -> Any
            els.filterDurationBtn.addEventListener('click', () => {
                const modes = ['any', 'short', 'long'];
                const currentIdx = modes.indexOf(state.filters.duration);
                state.filters.duration = modes[(currentIdx + 1) % modes.length];
                updateFilterUI();
                applyFiltersAndRender();
            });

            // Date: All -> 1m -> 1y -> All (Simplification for single click)
            // Ideally this would be a dropdown. Implementing a simple cycle for now.
            // Requirement was: 1m, 3m, 6m, 1y, 2y... All. That's too many for cycle.
            // Let's implement a simple dropdown logic for filters later or just cycle common ones.
            // For this specific requirement "High number of date options", let's use a prompt or simplified cycle.
            // Or better, let's just make it cycle: All -> 1 Month -> 1 Year -> 3 Years -> All
            els.filterDateBtn.addEventListener('click', () => {
                const modes = ['all', '1m', '1y', '5y'];
                const currentIdx = modes.indexOf(state.filters.date);
                state.filters.date = modes[(currentIdx + 1) % modes.length];
                updateFilterUI();
                applyFiltersAndRender();
            });

            // Score: All -> >10% -> >50% -> >150% -> All
            els.filterScoreBtn.addEventListener('click', () => {
                const modes = ['all', 'low', 'mid', 'high', 'very_high']; // corresponding to reqs
                const currentIdx = modes.indexOf(state.filters.score);
                state.filters.score = modes[(currentIdx + 1) % modes.length];
                updateFilterUI();
                applyFiltersAndRender();
            });

            els.resetFiltersBtn.addEventListener('click', () => {
                state.filters = { duration: 'any', date: 'all', score: 'all' };
                updateFilterUI();
                applyFiltersAndRender();
            });
        }

        function setLanguage(lang) {
            state.lang = lang;
            saveState();
            updateLanguage(lang);
            renderHistory(); // Re-render to translate clear button if needed
            applyFiltersAndRender(); // Re-render videos for translated timeAgo
        }

        function updateLanguage(lang) {
            const t = I18N[lang];
            const langNames = { en: 'English', ko: '한국어', zh: '中文', ja: '日本語' };

            els.currentLangLabel.textContent = langNames[lang];
            els.searchInput.placeholder = t.searchPlaceholder;
            els.apiKeyInput.placeholder = t.apiKeyPlaceholder;
            els.searchBtn.textContent = t.analyzeBtn;
            document.querySelector('.text-label-history').textContent = t.recentSearches;
            document.querySelector('.text-label-clear').textContent = t.clearHistory;
            document.querySelector('.text-label-filters').textContent = t.filters;
            document.querySelector('.text-label-reset').textContent = t.resetAll;
            document.querySelector('.text-label-results').textContent = t.results;
            document.querySelector('.text-label-sort').textContent = t.sort;
            document.querySelector('.text-label-start-prompt').textContent = t.startPrompt;

            document.title = t.title;

            updateFilterUI();
        }

        function updateFilterUI() {
            const t = I18N[state.lang];

            // Duration
            let durText = t.durationAny;
            if (state.filters.duration === 'short') durText = t.durationShort;
            if (state.filters.duration === 'long') durText = t.durationLong;
            els.labelDuration.textContent = durText;

            // Date
            let dateText = t.dateAll;
            if (state.filters.date === '1m') dateText = "1 Month"; // TODO: Translate
            if (state.filters.date === '1y') dateText = "1 Year";
            if (state.filters.date === '5y') dateText = "5 Years";
            els.labelDate.textContent = dateText;

            // Score
            let scoreText = t.scoreAll;
            if (state.filters.score === 'low') scoreText = "Score: < 10%";
            if (state.filters.score === 'mid') scoreText = "Score: 10-50%";
            if (state.filters.score === 'high') scoreText = "Score: 50-150%";
            if (state.filters.score === 'very_high') scoreText = "Score: > 150%";
            els.labelScore.textContent = scoreText;

            // Update button styles for active state
            const setActive = (btn, isActive) => {
                if (isActive) {
                    btn.className = "flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-4 py-1.5 text-sm font-medium text-primary hover:bg-primary/20 dark:border-primary/50 dark:text-blue-400";
                } else {
                    btn.className = "flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700";
                }
            };

            setActive(els.filterDurationBtn, state.filters.duration !== 'any');
            setActive(els.filterDateBtn, state.filters.date !== 'all');
            setActive(els.filterScoreBtn, state.filters.score !== 'all');
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            state.history.forEach(term => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <button onclick="performSearch('${term}')" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800/50 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">history</span>
                        <span>${term}</span>
                    </button>
                `;
                els.historyList.appendChild(li);
            });
        }

        function renderVideoSkeleton() {
            els.videoGrid.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                els.videoGrid.innerHTML += `
                    <div class="flex flex-col overflow-hidden rounded-xl bg-white dark:bg-surface-dark shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 animate-pulse">
                        <div class="aspect-video w-full bg-slate-200 dark:bg-slate-700"></div>
                        <div class="flex flex-col p-4 space-y-3">
                            <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded w-3/4"></div>
                            <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2"></div>
                            <div class="mt-4 flex items-center gap-3">
                                <div class="h-9 w-9 rounded-full bg-slate-200 dark:bg-slate-700"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-3 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                                    <div class="h-3 bg-slate-200 dark:bg-slate-700 rounded w-1/4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Core API Logic
         */
        async function performSearch(query) {
            if (!query) return;
            if (!state.apiKey) {
                alert(I18N[state.lang].errorApiKey);
                return;
            }

            // Update History
            if (!state.history.includes(query)) {
                state.history.unshift(query);
                if (state.history.length > 10) state.history.pop();
                saveState();
                renderHistory();
            }

            renderVideoSkeleton();
            els.resultCount.textContent = I18N[state.lang].loading;

            try {
                // Step 1: Search API
                console.log("Step 1: Fetching Search Results...");
                const searchParams = new URLSearchParams({
                    part: 'snippet',
                    maxResults: '30',
                    q: query,
                    type: 'video',
                    key: state.apiKey
                });

                const searchRes = await fetch(`https://www.googleapis.com/youtube/v3/search?${searchParams}`);
                if (!searchRes.ok) throw new Error(`Search API Error: ${searchRes.status}`);
                const searchData = await searchRes.json();

                const videoIds = searchData.items.map(item => item.id.videoId).join(',');
                if (!videoIds) {
                    els.videoGrid.innerHTML = '<p class="col-span-full text-center py-10">No results found.</p>';
                    return;
                }

                // Step 2: Videos API
                console.log("Step 2: Fetching Video Details...");
                const videosParams = new URLSearchParams({
                    part: 'snippet,contentDetails,statistics',
                    id: videoIds,
                    key: state.apiKey
                });
                const videosRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?${videosParams}`);
                if (!videosRes.ok) throw new Error(`Videos API Error: ${videosRes.status}`);
                const videosData = await videosRes.json();

                // Step 3: Channels API
                console.log("Step 3: Fetching Channel Details...");
                const channelIds = [...new Set(videosData.items.map(v => v.snippet.channelId))].join(',');
                const channelsParams = new URLSearchParams({
                    part: 'statistics',
                    id: channelIds,
                    key: state.apiKey
                });
                const channelsRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?${channelsParams}`);
                if (!channelsRes.ok) throw new Error(`Channels API Error: ${channelsRes.status}`);
                const channelsData = await channelsRes.json();

                // Step 4: Merge Data
                const channelMap = {};
                channelsData.items.forEach(c => {
                    channelMap[c.id] = c.statistics.subscriberCount;
                });

                state.videos = videosData.items.map(v => {
                    const subs = channelMap[v.snippet.channelId] || 0;
                    const views = v.statistics.viewCount || 0;
                    const durationObj = parseDuration(v.contentDetails.duration);

                    return {
                        id: v.id,
                        title: v.snippet.title,
                        thumbnail: v.snippet.thumbnails.medium.url,
                        channelTitle: v.snippet.channelTitle,
                        channelId: v.snippet.channelId,
                        publishedAt: v.snippet.publishedAt,
                        views: parseInt(views),
                        subscribers: parseInt(subs),
                        score: calculateScore(views, subs),
                        duration: durationObj.formatted,
                        durationSeconds: durationObj.totalSeconds
                    };
                });

                // Track Usage (rough estimate)
                const quota = 100 + 1 + 1; // Search (100) + Videos (1) + Channels (1)
                els.apiUsageInfo.classList.remove('hidden');
                els.quotaUsed.textContent = parseInt(els.quotaUsed.textContent) + quota;

                applyFiltersAndRender();

            } catch (err) {
                console.error(err);
                alert(`Error: ${err.message}`);
                els.videoGrid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">Error occurred. Check console/API Key.</p>`;
                els.resultCount.textContent = "";
            }
        }

        function applyFiltersAndRender() {
            let filtered = [...state.videos];

            // 1. Duration Filter
            if (state.filters.duration === 'short') { // < 2min (120s)
                filtered = filtered.filter(v => v.durationSeconds < 120);
            } else if (state.filters.duration === 'long') { // >= 2min
                filtered = filtered.filter(v => v.durationSeconds >= 120);
            }

            // 2. Date Filter
            const now = new Date();
            if (state.filters.date !== 'all') {
                filtered = filtered.filter(v => {
                    const vidDate = new Date(v.publishedAt);
                    const diffDays = (now - vidDate) / (1000 * 60 * 60 * 24);

                    if (state.filters.date === '1m') return diffDays <= 30;
                    if (state.filters.date === '1y') return diffDays <= 365;
                    if (state.filters.date === '5y') return diffDays <= 365 * 5;
                    return true;
                });
            }

            // 3. Score Filter
            if (state.filters.score !== 'all') {
                filtered = filtered.filter(v => {
                    const s = parseFloat(v.score); // Score is formatted string %
                    if (state.filters.score === 'low') return s < 10;
                    if (state.filters.score === 'mid') return s >= 10 && s < 50;
                    if (state.filters.score === 'high') return s >= 50 && s < 150;
                    if (state.filters.score === 'very_high') return s >= 150;
                    return true;
                });
            }

            // Sorting
            filtered.sort((a, b) => {
                if (state.sortBy === 'score_desc') return b.score - a.score;
                if (state.sortBy === 'views_desc') return b.views - a.views;
                if (state.sortBy === 'date_desc') return new Date(b.publishedAt) - new Date(a.publishedAt);
                return 0; // relevance (default API order)
            });

            state.filteredVideos = filtered;
            els.resultCount.textContent = `(${filtered.length} found)`;
            renderVideoGrid(filtered);
        }

        function renderVideoGrid(videos) {
            els.videoGrid.innerHTML = '';

            if (videos.length === 0) {
                els.videoGrid.innerHTML = '<p class="col-span-full text-center py-10 text-slate-500">No videos match the filters.</p>';
                return;
            }

            const t = I18N[state.lang];

            videos.forEach(video => {
                // Dynamic Badge Color based on score
                let badgeColor = 'bg-slate-600';
                const s = parseFloat(video.score);
                if (s >= 150) badgeColor = 'bg-yt-red';
                else if (s >= 50) badgeColor = 'bg-green-600';
                else if (s >= 10) badgeColor = 'bg-yellow-500';

                const article = document.createElement('article');
                article.className = "group relative flex flex-col overflow-hidden rounded-xl bg-white dark:bg-surface-dark shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 hover:shadow-md transition-shadow";
                article.innerHTML = `
                    <div class="relative aspect-video w-full overflow-hidden bg-slate-200 cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                        <img alt="${video.title}" class="h-full w-full object-cover group-hover:scale-105 transition-transform duration-500" src="${video.thumbnail}" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60"></div>
                        <span class="absolute bottom-2 right-2 rounded bg-black/80 px-1.5 py-0.5 text-xs font-bold text-white">${video.duration}</span>
                        <span class="absolute top-2 left-2 flex items-center gap-1 rounded ${badgeColor} px-2 py-1 text-xs font-bold text-white shadow-sm" title="Performance Score: Views/Subs">
                            <span class="material-symbols-outlined text-[14px]">trending_up</span>
                            ${video.score}%
                        </span>
                    </div>
                    <div class="flex flex-1 flex-col p-4">
                        <h3 class="text-base font-bold leading-tight text-slate-900 dark:text-white line-clamp-2 mb-2 group-hover:text-primary transition-colors cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                            ${video.title}
                        </h3>
                        <div class="mt-auto flex items-start gap-3">
                             <div class="flex flex-col text-xs text-slate-500 dark:text-slate-400 w-full">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium text-slate-900 dark:text-slate-200 truncate pr-2">${video.channelTitle}</span>
                                    <span>${formatNumber(video.subscribers)} ${t.subs}</span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-400">
                                    <span>${formatNumber(video.views)} ${t.views}</span>
                                    <span>•</span>
                                    <span>${timeAgo(video.publishedAt)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                els.videoGrid.appendChild(article);
            });
        }

        // Run
        init();

    </script>
</body>

</html>