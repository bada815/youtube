<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>TubeScope - YouTube Competitor Analysis Tool</title>
    <meta name="description" content="Analyze YouTube competitors and video performance with this tool.">
    <meta property="og:image"
        content="https://lh3.googleusercontent.com/aida-public/AB6AXuCDprc-ztABUtxrQR8tmjex1ciSWuba0ztkKF19z6no-FdNt0v74dcaxkkzYIbvxlYnTRsthm4EoiJqMlR6Pec2Kvm2ilwbKtCchb7ecCF0wRH2hzHoxWVvil2GhS8d_tN4WEdoNsM83DpQ1khNWXAwKdje30dysGtB0CDefMI0u5YUhIC4ILGX5EwyAliJYtHPWdJoXHPJcVRLVVTaE07fjY93wOUusy1ms6aJCVFcEfJOeAngxJEH35MqiW1dKXbQfAmSori59a03">

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />

    <link href="./output.css" rel="stylesheet" />
    <style>
        /* Custom scrollbar for sidebar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Modal Transitions */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms ease-out, transform 200ms ease-out;
        }

        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }

        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 200ms ease-in, transform 200ms ease-in;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-100 flex flex-col h-screen overflow-hidden antialiased selection:bg-primary/30">
    <!-- Header -->
    <header
        class="h-16 shrink-0 z-20 flex items-center justify-between border-b border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-[#111a22] px-4 lg:px-6 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex items-center justify-center size-8 rounded-lg bg-yt-red/10 text-yt-red">
                <span class="material-symbols-outlined text-2xl">travel_explore</span>
            </div>
            <h1 class="text-lg font-bold tracking-tight hidden sm:block">TubeScope</h1>
        </div>

        <div class="flex items-center gap-2 sm:gap-3">

            <!-- Usage Stats Button -->
            <button id="usage-btn"
                class="p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-100 rounded-lg transition-colors"
                title="API Usage">
                <span class="material-symbols-outlined">bar_chart</span>
            </button>

            <!-- Settings Button -->
            <button id="settings-btn"
                class="p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-100 rounded-lg transition-colors"
                title="Settings">
                <span class="material-symbols-outlined">settings</span>
            </button>

            <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>

            <!-- Language Dropdown -->
            <div class="relative group mr-2 hidden md:block">
                <button id="lang-btn"
                    class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                    <span class="material-symbols-outlined text-[20px]">language</span>
                    <span id="current-lang-label">English</span>
                    <span class="material-symbols-outlined text-[16px]">expand_more</span>
                </button>
                <div
                    class="absolute right-0 top-full mt-2 w-40 rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-right">
                    <div class="py-1">
                        <button onclick="setLanguage('en')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">English</button>
                        <button onclick="setLanguage('ko')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">한국어</button>
                        <button onclick="setLanguage('zh')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">中文</button>
                        <button onclick="setLanguage('ja')"
                            class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white">日本語</button>
                    </div>
                </div>
            </div>

            <button id="theme-toggle"
                class="p-2 text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 rounded-lg transition-colors">
                <span class="material-symbols-outlined">light_mode</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside
            class="w-64 shrink-0 hidden md:flex flex-col border-r border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-[#111a22]">
            <div class="p-4 flex flex-col h-full">
                <div class="mb-6">
                    <h2
                        class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3 px-2 text-label-history">
                        Recent Searches
                    </h2>
                    <ul id="history-list" class="space-y-1">
                        <!-- History Items will be injected here -->
                    </ul>
                </div>
                <div class="mt-auto pt-4 border-t border-slate-200 dark:border-slate-800">
                    <button id="clear-history-btn"
                        class="flex w-full items-center justify-center gap-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-transparent px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">delete_sweep</span>
                        <span class="text-label-clear">Clear History</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark relative scroll-smooth">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

                <!-- Search Section -->
                <div class="space-y-4">
                    <div class="relative shadow-lg rounded-xl">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-slate-400 text-2xl">search</span>
                        </div>
                        <input id="search-input"
                            class="block w-full rounded-xl border-0 py-4 pl-12 pr-20 text-slate-900 ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary dark:bg-surface-dark dark:ring-slate-700 dark:text-white text-lg shadow-sm"
                            placeholder="Analyze a keyword (e.g., 'productivity hacks') or channel..." type="text" />
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2">
                            <button id="search-btn"
                                class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors">
                                Analyze
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="flex flex-wrap items-center gap-3 relative z-10">
                        <span
                            class="text-xs font-semibold text-slate-500 uppercase mr-1 text-label-filters">Filters:</span>

                        <!-- Duration Filter -->
                        <div class="relative inline-block text-left">
                            <button id="filter-duration-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 transition-colors"
                                data-dropdown="dropdown-duration">
                                <span id="label-duration">Duration: Any</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="dropdown-duration"
                                class="hidden absolute left-0 mt-2 w-48 origin-top-left rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10 z-50 focus:outline-none">
                                <div class="py-1">
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="duration" data-value="any">Duration: Any</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="duration" data-value="short">Short (< 2m)</button>
                                            <button
                                                class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                                data-type="duration" data-value="long">Long (≥ 2m)</button>
                                </div>
                            </div>
                        </div>

                        <!-- Date Filter -->
                        <div class="relative inline-block text-left">
                            <button id="filter-date-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 transition-colors"
                                data-dropdown="dropdown-date">
                                <span id="label-date">Date: All Time</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="dropdown-date"
                                class="hidden absolute left-0 mt-2 w-48 origin-top-left rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10 z-50 focus:outline-none">
                                <div class="py-1">
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="date" data-value="all">Date: All Time</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="date" data-value="1m">Last Month</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="date" data-value="1y">Last Year</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="date" data-value="5y">Last 5 Years</button>
                                </div>
                            </div>
                        </div>

                        <!-- Score Filter -->
                        <div class="relative inline-block text-left">
                            <button id="filter-score-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 transition-colors"
                                data-dropdown="dropdown-score">
                                <span id="label-score">Score: All</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="dropdown-score"
                                class="hidden absolute left-0 mt-2 w-48 origin-top-left rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10 z-50 focus:outline-none">
                                <div class="py-1">
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="score" data-value="all">Score: All</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="score" data-value="low">Score: < 10%</button>
                                            <button
                                                class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                                data-type="score" data-value="mid">Score: 10-50%</button>
                                            <button
                                                class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                                data-type="score" data-value="high">Score: 50-150%</button>
                                            <button
                                                class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                                data-type="score" data-value="very_high">Score: > 150%</button>
                                </div>
                            </div>
                        </div>

                        <!-- Limit Filter -->
                        <div class="relative inline-block text-left">
                            <button id="filter-limit-btn"
                                class="filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 transition-colors"
                                data-dropdown="dropdown-limit">
                                <span id="label-limit">Results: 30</span>
                                <span class="material-symbols-outlined text-[18px]">arrow_drop_down</span>
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="dropdown-limit"
                                class="hidden absolute left-0 mt-2 w-32 origin-top-left rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black/5 dark:ring-white/10 z-50 focus:outline-none">
                                <div class="py-1">
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="10">10</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="30">30</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="50">50</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="70">70</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="90">90</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="150">150</button>
                                    <button
                                        class="dropdown-item block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary dark:text-slate-300 dark:hover:bg-slate-700/50 dark:hover:text-white"
                                        data-type="limit" data-value="300">300</button>
                                </div>
                            </div>
                        </div>

                        <div class="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-2"></div>
                        <button id="reset-filters-btn"
                            class="text-sm text-slate-500 hover:text-primary underline text-label-reset">Reset
                            all</button>
                    </div>
                </div>

                <!-- Results Area -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white"><span
                                class="text-label-results">Analysis Results</span> <span id="result-count"
                                class="ml-2 text-sm font-normal text-slate-500 dark:text-slate-400"></span></h2>
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <span class="text-label-sort">Sort by:</span>
                            <select id="sort-select"
                                class="bg-transparent border-none text-slate-900 dark:text-white font-medium focus:ring-0 cursor-pointer p-0 pr-6">
                                <option value="relevance">Relevance</option>
                                <option value="score_desc">Score (High to Low)</option>
                                <option value="views_desc">Views (High to Low)</option>
                                <option value="date_desc">Date (Newest)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Video Grid -->
                    <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- Initial Idle State -->
                        <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                            <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-full mb-4">
                                <span
                                    class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">search</span>
                            </div>
                            <p class="text-lg font-medium text-slate-600 dark:text-slate-300 text-label-start-prompt">
                                Enter a keyword to start analyzing.</p>
                            <p class="text-sm text-slate-400 mt-2">Try "Travel Vlog" or "Tech Review"</p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="mt-12 border-t border-slate-200 dark:border-slate-800 pt-8 pb-4">
                    <!-- Ad Banner Section -->
                    <div id="ad-banner-container" class="w-full mb-8 px-4">
                        <div
                            class="max-w-7xl mx-auto h-24 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-lg flex items-center justify-center bg-slate-50 dark:bg-slate-800/50">
                            <span class="text-slate-400 dark:text-slate-500 font-medium tracking-wide">Advertisement
                                Space</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-center gap-6">
                        <div class="flex items-center gap-6 text-sm text-slate-500 dark:text-slate-400">
                            <a class="hover:text-primary" href="#">Privacy Policy</a>
                            <a class="hover:text-primary" href="#">Terms of Service</a>
                        </div>
                        <p class="text-xs text-slate-400">© 2024 TubeScope. Not affiliated with YouTube.</p>
                    </div>
                </footer>
            </div>
        </main>
    </div>



    <!-- Modals -->

    <!-- API Key Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" role="dialog"
        aria-modal="true">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" id="settings-backdrop"></div>
        <div
            class="relative bg-white dark:bg-surface-dark rounded-xl shadow-2xl max-w-sm w-full mx-4 p-6 transform transition-all scale-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">settings</span>
                    <span>Settings</span>
                </h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">YouTube Data API
                        Key</label>
                    <input id="modal-api-key" type="password"
                        class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-black/20 text-slate-900 dark:text-white focus:ring-primary focus:border-primary text-sm p-2.5"
                        placeholder="Paste your API key here">
                    <p class="mt-1 text-xs text-slate-500">
                        Keys are stored locally in your browser.
                    </p>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button
                    class="modal-close px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="save-api-key-btn"
                    class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-blue-600 rounded-lg shadow-sm transition-colors">
                    Save Key
                </button>
            </div>
        </div>
    </div>

    <!-- Usage Dashboard Modal -->
    <div id="usage-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" role="dialog"
        aria-modal="true">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" id="usage-backdrop"></div>
        <div
            class="relative bg-white dark:bg-surface-dark rounded-xl shadow-2xl max-w-sm w-full mx-4 p-6 transform transition-all scale-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-green-500">bar_chart</span>
                    <span>API Usage</span>
                </h3>
                <button class="modal-close text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-1">Today's Usage</p>
                    <div class="text-3xl font-bold text-slate-900 dark:text-white" id="usage-count">0</div>
                    <p class="text-xs text-slate-400">units used</p>
                </div>

                <div>
                    <div class="flex justify-between text-xs text-slate-500 mb-1">
                        <span>Daily Quota</span>
                        <span><span id="usage-percent">0</span>%</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                        <div id="usage-bar" class="bg-primary h-2.5 rounded-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>0</span>
                        <span>10,000</span>
                    </div>
                </div>

                <div
                    class="text-xs text-slate-500 dark:text-slate-400 space-y-1 bg-yellow-50 dark:bg-yellow-900/10 p-3 rounded-lg border border-yellow-100 dark:border-yellow-900/20">
                    <p class="font-semibold text-yellow-700 dark:text-yellow-500">Cost Breakdown:</p>
                    <div class="flex justify-between"><span>Search Query</span> <span>100 units</span></div>
                    <div class="flex justify-between"><span>Video Details</span> <span>1 unit</span></div>
                    <div class="flex justify-between"><span>Channel Details</span> <span>1 unit</span></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button
                    class="modal-close px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal (Welcome) -->
    <div id="onboarding-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" role="dialog"
        aria-modal="true">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-md" id="onboarding-backdrop"></div>
        <!-- No close on backdrop -->
        <div
            class="relative bg-white dark:bg-surface-dark rounded-xl shadow-2xl max-w-md w-full mx-4 p-8 transform transition-all scale-100 text-center">

            <div class="mx-auto flex items-center justify-center size-16 rounded-full bg-primary/10 text-primary mb-6">
                <span class="material-symbols-outlined text-4xl">vpn_key</span>
            </div>

            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Welcome to TubeScope</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">
                To start analyzing YouTube data with <strong>TubeScope</strong>, you need a free <strong>YouTube Data
                    API Key</strong>. <br>
                Please enter your key below to continue.
            </p>

            <div
                class="text-left mb-6 bg-slate-50 dark:bg-slate-800 p-4 rounded-lg text-xs space-y-2 text-slate-600 dark:text-slate-300">
                <p><strong>How to get a key:</strong></p>
                <ol class="list-decimal pl-4 space-y-1">
                    <li>Go to <a href="https://console.cloud.google.com/" target="_blank"
                            class="text-primary hover:underline">Google Cloud Console</a>.</li>
                    <li>Create a new project.</li>
                    <li>Enable "YouTube Data API v3".</li>
                    <li>Create Credentials (API Key).</li>
                </ol>
            </div>

            <div class="space-y-4">
                <input id="onboarding-api-key" type="password"
                    class="block w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-black/20 text-slate-900 dark:text-white focus:ring-primary focus:border-primary text-center font-mono"
                    placeholder="Paste API Key">
                <button id="onboarding-save-btn"
                    class="w-full py-3 text-sm font-bold text-white bg-primary hover:bg-blue-600 rounded-lg shadow-lg hover:shadow-primary/30 transition-all transform hover:-translate-y-0.5">
                    Get Started
                </button>
            </div>
        </div>
    </div>


    <!-- Application Logic -->
    <script>
        /**
         * Internationalization (I18N) Dictionary
         */
        const I18N = {
            en: {
                title: "TubeScope",
                searchPlaceholder: "Analyze a keyword (e.g., 'productivity hacks')...",
                analyzeBtn: "Analyze",
                recentSearches: "Recent Searches",
                clearHistory: "Clear History",
                filters: "Filters:",
                durationAny: "Duration: Any",
                durationShort: "Short (< 2m)",
                durationLong: "Long (≥ 2m)",
                dateAll: "Date: All Time",
                date1m: "Last Month",
                date1y: "Last Year",
                date5y: "Last 5 Years",
                limitLabel: "Results:",
                scoreAll: "Score: All",
                scoreLow: "Score: < 10%",
                scoreMid: "Score: 10-50%",
                scoreHigh: "Score: 50-150%",
                scoreVeryHigh: "Score: > 150%",
                resetAll: "Reset all",
                results: "Analysis Results",
                sort: "Sort by:",
                startPrompt: "Enter a keyword to start analyzing.",
                loading: "Loading...",
                errorApiKey: "Please check your settings and enter a valid API Key.",
                views: "views",
                subs: "subscribers",
                score: "Score",
                daysAgo: "days ago",
                hoursAgo: "hours ago",
                minutesAgo: "minutes ago",
                monthsAgo: "months ago",
                yearsAgo: "years ago"
            },
            ko: {
                title: "TubeScope",
                searchPlaceholder: "키워드를 입력하세요 (예: '생산성 꿀팁')...",
                analyzeBtn: "분석하기",
                recentSearches: "최근 검색 기록",
                clearHistory: "기록 삭제",
                filters: "필터:",
                durationAny: "길이: 전체",
                durationShort: "숏폼 (2분 미만)",
                durationLong: "롱폼 (2분 이상)",
                dateAll: "날짜: 전체",
                date1m: "지난 달",
                date1y: "지난 해",
                date5y: "지난 5년",
                limitLabel: "검색량:",
                scoreAll: "점수: 전체",
                scoreLow: "점수: 10% 미만",
                scoreMid: "점수: 10-50%",
                scoreHigh: "점수: 50-150%",
                scoreVeryHigh: "점수: 150% 이상",
                resetAll: "초기화",
                results: "분석 결과",
                sort: "정렬:",
                startPrompt: "키워드를 입력하여 분석을 시작하세요.",
                loading: "로딩 중...",
                errorApiKey: "설정에서 유효한 API 키를 입력해주세요.",
                views: "조회수",
                subs: "구독자",
                score: "성과 점수",
                daysAgo: "일 전",
                hoursAgo: "시간 전",
                minutesAgo: "분 전",
                monthsAgo: "개월 전",
                yearsAgo: "년 전"
            },
            zh: {
                title: "TubeScope",
                searchPlaceholder: "输入关键字进行分析...",
                analyzeBtn: "分析",
                recentSearches: "最近搜索",
                clearHistory: "清除历史",
                filters: "筛选:",
                durationAny: "时长: 全部",
                durationShort: "短视频 (< 2分)",
                durationLong: "长视频 (≥ 2分)",
                dateAll: "日期: 全部",
                date1m: "上个月",
                date1y: "去年",
                date5y: "过去5年",
                limitLabel: "数量:",
                scoreAll: "评分: 全部",
                scoreLow: "评分: < 10%",
                scoreMid: "评分: 10-50%",
                scoreHigh: "评分: 50-150%",
                scoreVeryHigh: "评分: > 150%",
                resetAll: "重置",
                results: "分析结果",
                sort: "排序:",
                startPrompt: "输入关键字以开始分析。",
                loading: "加载中...",
                errorApiKey: "请在设置中输入有效的API密钥。",
                views: "观看次数",
                subs: "订阅者",
                score: "评分",
                daysAgo: "天前",
                hoursAgo: "小时前",
                minutesAgo: "分钟前",
                monthsAgo: "个月前",
                yearsAgo: "年前"
            },
            ja: {
                title: "TubeScope",
                searchPlaceholder: "キーワードを入力して分析...",
                analyzeBtn: "分析",
                recentSearches: "最近の検索",
                clearHistory: "履歴を削除",
                filters: "フィルター:",
                durationAny: "長さ: すべて",
                durationShort: "ショート (< 2分)",
                durationLong: "ロング (≥ 2分)",
                dateAll: "日付: すべて",
                date1m: "先月",
                date1y: "昨年",
                date5y: "過去5年",
                limitLabel: "件数:",
                scoreAll: "スコア: すべて",
                scoreLow: "スコア: < 10%",
                scoreMid: "スコア: 10-50%",
                scoreHigh: "スコア: 50-150%",
                scoreVeryHigh: "スコア: > 150%",
                resetAll: "リセット",
                results: "分析結果",
                sort: "並び替え:",
                startPrompt: "キーワードを入力して分析を開始してください。",
                loading: "読み込み中...",
                errorApiKey: "設定で有効なAPIキーを入力してください。",
                views: "回視聴",
                subs: "登録者",
                score: "スコア",
                daysAgo: "日前",
                hoursAgo: "時間前",
                minutesAgo: "分前",
                monthsAgo: "ヶ月前",
                yearsAgo: "年前"
            }
        };

        /**
         * Quota Manager System
         */
        const QuotaManager = {
            DAILY_LIMIT: 10000,

            getUsage() {
                const today = new Date().toISOString().split('T')[0];
                const storedDate = localStorage.getItem('yt_quota_date');

                // Reset if new day
                if (storedDate !== today) {
                    localStorage.setItem('yt_quota_date', today);
                    localStorage.setItem('yt_quota_used', '0');
                    return 0;
                }

                return parseInt(localStorage.getItem('yt_quota_used') || '0');
            },

            addUsage(cost) {
                const current = this.getUsage();
                const newVal = current + cost;
                localStorage.setItem('yt_quota_used', newVal.toString());
                return newVal;
            },

            render(usageCount) {
                const countEl = document.getElementById('usage-count');
                const percentEl = document.getElementById('usage-percent');
                const barEl = document.getElementById('usage-bar');

                if (countEl && percentEl && barEl) {
                    const percent = Math.min((usageCount / this.DAILY_LIMIT) * 100, 100).toFixed(1);
                    countEl.textContent = usageCount.toLocaleString();
                    percentEl.textContent = percent;
                    barEl.style.width = `${percent}%`;

                    if (percent > 90) barEl.className = "h-2.5 rounded-full transition-all duration-500 bg-red-500";
                    else if (percent > 70) barEl.className = "h-2.5 rounded-full transition-all duration-500 bg-yellow-500";
                    else barEl.className = "h-2.5 rounded-full transition-all duration-500 bg-primary";
                }
            }
        };

        /**
         * State & Config
         */
        const state = {
            apiKey: localStorage.getItem('yt_api_key') || '',
            history: JSON.parse(localStorage.getItem('yt_search_history')) || [],
            lang: localStorage.getItem('yt_lang') || 'en',
            videos: [],
            filteredVideos: [],
            isDark: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches),
            filters: {
                duration: 'any',
                date: 'all',
                score: 'all'
            },
            maxResults: parseInt(localStorage.getItem('yt_max_results')) || 30,
            sortBy: 'relevance'
        };

        /**
         * DOM Elements UI Helpers
         */
        const els = {
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            historyList: document.getElementById('history-list'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            videoGrid: document.getElementById('video-grid'),
            resultCount: document.getElementById('result-count'),
            sortSelect: document.getElementById('sort-select'),
            themeToggle: document.getElementById('theme-toggle'),
            langBtn: document.getElementById('lang-btn'),
            currentLangLabel: document.getElementById('current-lang-label'),

            // Buttons
            settingsBtn: document.getElementById('settings-btn'),
            usageBtn: document.getElementById('usage-btn'),

            // Modals
            modals: {
                settings: document.getElementById('settings-modal'),
                usage: document.getElementById('usage-modal'),
                onboarding: document.getElementById('onboarding-modal')
            },

            // Modal Inputs
            modalApiKey: document.getElementById('modal-api-key'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            onboardingApiKey: document.getElementById('onboarding-api-key'),
            onboardingSaveBtn: document.getElementById('onboarding-save-btn'),

            // Filters
            filterDurationBtn: document.getElementById('filter-duration-btn'),
            filterDateBtn: document.getElementById('filter-date-btn'),
            filterScoreBtn: document.getElementById('filter-score-btn'),
            resetFiltersBtn: document.getElementById('reset-filters-btn'),
            labelDuration: document.getElementById('label-duration'),
            labelDate: document.getElementById('label-date'),
            labelScore: document.getElementById('label-score'),

            // Dropdowns (new)
            dropdowns: {
                duration: document.getElementById('dropdown-duration'),
                date: document.getElementById('dropdown-date'),
                score: document.getElementById('dropdown-score'),
                limit: document.getElementById('dropdown-limit')
            },
            filterLimitBtn: document.getElementById('filter-limit-btn'),
            labelLimit: document.getElementById('label-limit')
        };

        const toggleModal = (modalId, show) => {
            const el = document.getElementById(modalId);
            if (show) {
                el.classList.remove('hidden');
                // Trigger reflow
                void el.offsetWidth;
                // Add show class? We used simple CSS classes in this demo. Just removing hidden is fine.
            } else {
                el.classList.add('hidden');
            }
        };

        /**
         * Logic Functions
         */
        function saveState() {
            localStorage.setItem('yt_api_key', state.apiKey);
            localStorage.setItem('yt_search_history', JSON.stringify(state.history));
            localStorage.setItem('yt_lang', state.lang);
            localStorage.setItem('yt_max_results', state.maxResults);
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const t = I18N[state.lang];

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " " + t.yearsAgo;
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " " + t.monthsAgo;
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " " + t.daysAgo;
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " " + t.hoursAgo;
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " " + t.minutesAgo;
            return "Just now";
        }

        function parseDuration(duration) {
            if (!duration || duration === 'P0D') return { formatted: "Live", totalSeconds: 0 };
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!match) return { formatted: "0:00", totalSeconds: 0 };

            const hours = match[1] ? parseInt(match[1]) : 0;
            const minutes = match[2] ? parseInt(match[2]) : 0;
            const seconds = match[3] ? parseInt(match[3]) : 0;
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;

            let formatted = "";
            if (hours > 0) formatted += hours + ":";
            formatted += (minutes < 10 && hours > 0 ? "0" : "") + minutes + ":";
            formatted += (seconds < 10 ? "0" : "") + seconds;
            if (hours === 0 && minutes === 0) formatted = "0:" + (seconds < 10 ? "0" : "") + seconds;

            return { formatted, totalSeconds };
        }

        function calculateScore(views, subs) {
            if (!subs || subs === 0) return 0;
            return ((views / subs) * 100).toFixed(1);
        }

        /**
         * Init & Events
         */
        function init() {
            // Restore dark mode
            if (state.isDark) document.documentElement.classList.add('dark');

            // Check API Key for onboarding
            if (!state.apiKey) {
                toggleModal('onboarding-modal', true);
            } else {
                els.modalApiKey.value = state.apiKey;
            }

            // Init Usage
            QuotaManager.render(QuotaManager.getUsage());

            updateLanguage(state.lang);
            renderHistory();

            // --- Event Listeners ---

            // Search
            const runSearch = () => performSearch(els.searchInput.value);
            els.searchBtn.addEventListener('click', runSearch);
            els.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') runSearch(); });

            // History Clear
            els.clearHistoryBtn.addEventListener('click', () => {
                state.history = [];
                saveState();
                renderHistory();
            });

            // Theme
            els.themeToggle.addEventListener('click', () => {
                state.isDark = !state.isDark;
                document.documentElement.classList.toggle('dark', state.isDark);
                localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
            });

            // Sorting
            els.sortSelect.addEventListener('change', (e) => {
                state.sortBy = e.target.value;
                applyFiltersAndRender();
            });

            // --- Modals ---

            // Settings
            els.settingsBtn.addEventListener('click', () => toggleModal('settings-modal', true));
            els.saveApiKeyBtn.addEventListener('click', () => {
                const newKey = els.modalApiKey.value.trim();
                if (newKey) {
                    state.apiKey = newKey;
                    saveState();
                    toggleModal('settings-modal', false);
                    alert("API Key Saved!");
                }
            });

            // Usage
            els.usageBtn.addEventListener('click', () => {
                QuotaManager.render(QuotaManager.getUsage());
                toggleModal('usage-modal', true);
            });

            // Onboarding
            els.onboardingSaveBtn.addEventListener('click', () => {
                const newKey = els.onboardingApiKey.value.trim();
                if (newKey) {
                    state.apiKey = newKey;
                    els.modalApiKey.value = newKey; // Sync to settings
                    saveState();
                    toggleModal('onboarding-modal', false);
                } else {
                    alert("Please enter a key to continue.");
                }
            });

            // Close Modals (Background & X buttons)
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('[role="dialog"]');
                    if (modal) modal.classList.add('hidden');
                });
            });
            ['settings-backdrop', 'usage-backdrop'].forEach(id => {
                document.getElementById(id).addEventListener('click', function () {
                    this.parentElement.classList.add('hidden');
                });
            });


            // --- Filters (Dropdown Logic) ---

            // 1. Toggle Dropdowns
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent global close
                    const dropdownId = btn.dataset.dropdown;
                    const dropdown = document.getElementById(dropdownId);

                    // Close others
                    document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                        if (d.id !== dropdownId) d.classList.add('hidden');
                    });

                    // Toggle current
                    dropdown.classList.toggle('hidden');
                });
            });

            // 2. Click Outside to Close
            document.addEventListener('click', () => {
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    d.classList.add('hidden');
                });
            });

            // 3. Selection Logic
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const type = e.target.dataset.type; // duration, date, score, limit
                    const value = e.target.dataset.value;

                    if (type === 'limit') {
                        state.maxResults = parseInt(value);
                        saveState();
                        updateFilterUI();
                        // Trigger search if we have a query
                        if (els.searchInput.value.trim()) {
                            performSearch(els.searchInput.value.trim());
                        }
                    } else {
                        state.filters[type] = value;
                        updateFilterUI();
                        applyFiltersAndRender();
                    }

                    // Close dropdown
                    e.target.closest('[id^="dropdown-"]').classList.add('hidden');
                });
            });

            els.resetFiltersBtn.addEventListener('click', () => {
                // 1. Reset Filters
                state.filters = { duration: 'any', date: 'all', score: 'all' };
                updateFilterUI();

                // 2. Clear Search Input
                els.searchInput.value = '';

                // 3. Clear Video Data
                state.videos = [];
                state.filteredVideos = [];
                els.resultCount.textContent = '';

                // 4. Restore Idle/Welcome State
                const t = I18N[state.lang];
                els.videoGrid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                        <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-full mb-4">
                            <span class="material-symbols-outlined text-4xl text-slate-300 dark:text-slate-600">search</span>
                        </div>
                        <p class="text-lg font-medium text-slate-600 dark:text-slate-300 text-label-start-prompt">
                            ${t.startPrompt}
                        </p>
                        <p class="text-sm text-slate-400 mt-2">Try "Travel Vlog" or "Tech Review"</p>
                    </div>
                `;
            });
        }

        function setLanguage(lang) {
            state.lang = lang;
            saveState();
            updateLanguage(lang);
            renderHistory();
            if (state.videos.length > 0) applyFiltersAndRender();
        }

        function updateLanguage(lang) {
            const t = I18N[lang];
            const langNames = { en: 'English', ko: '한국어', zh: '中文', ja: '日本語' };

            els.currentLangLabel.textContent = langNames[lang];
            els.searchInput.placeholder = t.searchPlaceholder;
            els.searchBtn.textContent = t.analyzeBtn;

            // Text Content Updates
            document.querySelector('.text-label-history').textContent = t.recentSearches;
            document.querySelector('.text-label-clear').textContent = t.clearHistory;
            document.querySelector('.text-label-filters').textContent = t.filters;
            document.querySelector('.text-label-reset').textContent = t.resetAll;
            document.querySelector('.text-label-results').textContent = t.results;
            document.querySelector('.text-label-sort').textContent = t.sort;
            const startPromptEl = document.querySelector('.text-label-start-prompt');
            if (startPromptEl) startPromptEl.textContent = t.startPrompt;

            document.title = t.title;

            // Dropdown items text update (re-render or just direct text update)
            // Ideally we'd map this dynamically, but for this file-size constraint:
            const setDropdownText = (type, val, text) => {
                const el = document.querySelector(`.dropdown-item[data-type="${type}"][data-value="${val}"]`);
                if (el) el.textContent = text;
            }

            setDropdownText('duration', 'any', t.durationAny);
            setDropdownText('duration', 'short', t.durationShort);
            setDropdownText('duration', 'long', t.durationLong);

            setDropdownText('date', 'all', t.dateAll);
            setDropdownText('date', '1m', t.date1m);
            setDropdownText('date', '1y', t.date1y);
            setDropdownText('date', '5y', t.date5y);

            setDropdownText('score', 'all', t.scoreAll);
            setDropdownText('score', 'low', t.scoreLow);
            setDropdownText('score', 'mid', t.scoreMid);
            setDropdownText('score', 'high', t.scoreHigh);
            setDropdownText('score', 'very_high', t.scoreVeryHigh);

            // Explicitly update filter button labels for localization
            const getLabel = (type, val) => {
                if (type === 'duration') {
                    if (val === 'short') return t.durationShort;
                    if (val === 'long') return t.durationLong;
                    return t.durationAny;
                }
                if (type === 'date') {
                    if (val === '1m') return t.date1m;
                    if (val === '1y') return t.date1y;
                    if (val === '5y') return t.date5y;
                    return t.dateAll;
                }
                if (type === 'score') {
                    if (val === 'low') return t.scoreLow;
                    if (val === 'mid') return t.scoreMid;
                    if (val === 'high') return t.scoreHigh;
                    if (val === 'very_high') return t.scoreVeryHigh;
                    return t.scoreAll;
                }
            };

            els.labelDuration.textContent = getLabel('duration', state.filters.duration);
            els.labelDate.textContent = getLabel('date', state.filters.date);
            els.labelScore.textContent = getLabel('score', state.filters.score);

            updateFilterUI();
        }

        function updateFilterUI() {
            const t = I18N[state.lang];

            // Helper to determine label text
            const getLabel = (type, val) => {
                if (type === 'duration') {
                    if (val === 'short') return t.durationShort;
                    if (val === 'long') return t.durationLong;
                    return t.durationAny;
                }
                if (type === 'date') {
                    if (val === '1m') return t.date1m;
                    if (val === '1y') return t.date1y;
                    if (val === '5y') return t.date5y;
                    return t.dateAll;
                }
                if (type === 'score') {
                    if (val === 'low') return t.scoreLow;
                    if (val === 'mid') return t.scoreMid;
                    if (val === 'high') return t.scoreHigh;
                    if (val === 'very_high') return t.scoreVeryHigh;
                    return t.scoreAll;
                }
            };

            // Update labels
            els.labelDuration.textContent = getLabel('duration', state.filters.duration);
            els.labelDate.textContent = getLabel('date', state.filters.date);
            els.labelScore.textContent = getLabel('score', state.filters.score);
            els.labelLimit.textContent = t.limitLabel + " " + (state.maxResults || 30);

            // Update Active State Visuals
            const isActive = (key, defaultVal) => state.filters[key] !== defaultVal;
            const setStyle = (btn, active) => {
                if (active) btn.className = "filter-btn flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-4 py-1.5 text-sm font-medium text-primary hover:bg-primary/20 dark:border-primary/50 dark:text-blue-400";
                else btn.className = "filter-btn flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700";
            };

            setStyle(els.filterDurationBtn, isActive('duration', 'any'));
            setStyle(els.filterDateBtn, isActive('date', 'all'));
            setStyle(els.filterScoreBtn, isActive('score', 'all'));
        }

        function renderHistory() {
            els.historyList.innerHTML = '';
            state.history.forEach(term => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <button onclick="performSearch('${term}')" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800/50 transition-colors">
                        <span class="material-symbols-outlined text-[18px]">history</span>
                        <span>${term}</span>
                    </button>
                `;
                els.historyList.appendChild(li);
            });
        }

        // Helper to expose search to window for history clicks
        window.performSearch = async (query) => {
            els.searchInput.value = query; // Visual sync
            if (!query) return;
            if (!state.apiKey) {
                toggleModal('settings-modal', true);
                return;
            }

            // History Update
            if (!state.history.includes(query)) {
                state.history.unshift(query);
                if (state.history.length > 10) state.history.pop();
                saveState();
                renderHistory();
            }

            // Skeleton Loading
            els.videoGrid.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                els.videoGrid.innerHTML += `
                    <div class="flex flex-col overflow-hidden rounded-xl bg-white dark:bg-surface-dark shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 animate-pulse">
                        <div class="aspect-video w-full bg-slate-200 dark:bg-slate-700"></div>
                        <div class="flex flex-col p-4 space-y-3">
                            <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded w-3/4"></div>
                            <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2"></div>
                        </div>
                    </div>
                `;
            }
            els.resultCount.textContent = I18N[state.lang].loading;

            try {
                // Step 1: Search
                // Step 1: Search (Loop for > 50)
                let allSearchItems = [];
                let nextPageToken = '';
                const targetCount = state.maxResults || 30;

                while (allSearchItems.length < targetCount) {
                    const fetchSize = 50; // Always ask for 50 to minimize calls
                    const searchParams = new URLSearchParams({
                        part: 'snippet',
                        maxResults: fetchSize,
                        q: query,
                        type: 'video',
                        key: state.apiKey
                    });
                    if (nextPageToken) searchParams.append('pageToken', nextPageToken);

                    const searchRes = await fetch(`https://www.googleapis.com/youtube/v3/search?${searchParams}`);
                    if (!searchRes.ok) throw new Error("API Limit or Key Error");
                    const searchData = await searchRes.json();

                    QuotaManager.addUsage(100);

                    if (!searchData.items || searchData.items.length === 0) break;

                    allSearchItems = allSearchItems.concat(searchData.items);
                    nextPageToken = searchData.nextPageToken;

                    if (!nextPageToken) break;
                }

                // Trim to exact count
                if (allSearchItems.length > targetCount) {
                    allSearchItems = allSearchItems.slice(0, targetCount);
                }

                if (allSearchItems.length === 0) {
                    els.videoGrid.innerHTML = '<p class="col-span-full text-center py-10">No results found.</p>';
                    return;
                }

                // Helper to chunk array
                const chunkArray = (arr, size) => {
                    const chunks = [];
                    for (let i = 0; i < arr.length; i += size) {
                        chunks.push(arr.slice(i, i + size));
                    }
                    return chunks;
                };

                // Step 2: Videos (Batch Logic)
                const allVideoIds = allSearchItems.map(item => item.id.videoId);
                const videoIdChunks = chunkArray(allVideoIds, 50);

                let allVideos = [];

                for (const chunk of videoIdChunks) {
                    const videosParams = new URLSearchParams({ part: 'snippet,contentDetails,statistics', id: chunk.join(','), key: state.apiKey });
                    const videosRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?${videosParams}`);
                    const videosData = await videosRes.json();
                    QuotaManager.addUsage(1);
                    if (videosData.items) allVideos = allVideos.concat(videosData.items);
                }

                // Step 3: Channels (Batch Logic)
                const channelIds = [...new Set(allVideos.map(v => v.snippet.channelId))];
                const channelIdChunks = chunkArray(channelIds, 50);

                let allChannels = [];
                for (const chunk of channelIdChunks) {
                    const channelsParams = new URLSearchParams({ part: 'statistics', id: chunk.join(','), key: state.apiKey });
                    const channelsRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?${channelsParams}`);
                    const channelsData = await channelsRes.json();
                    QuotaManager.addUsage(1);
                    if (channelsData.items) allChannels = allChannels.concat(channelsData.items);
                }

                QuotaManager.render(QuotaManager.getUsage()); // Update Usage UI

                // Merge
                const channelMap = {};
                allChannels.forEach(c => { channelMap[c.id] = c.statistics.subscriberCount; });

                state.videos = allVideos.map(v => {
                    const subs = channelMap[v.snippet.channelId] || 0;
                    const views = v.statistics.viewCount || 0;
                    const d = parseDuration(v.contentDetails.duration);
                    return {
                        id: v.id,
                        title: v.snippet.title,
                        thumbnail: v.snippet.thumbnails.medium.url,
                        channelTitle: v.snippet.channelTitle,
                        publishedAt: v.snippet.publishedAt,
                        views: parseInt(views),
                        subscribers: parseInt(subs),
                        score: calculateScore(views, subs),
                        duration: d.formatted,
                        durationSeconds: d.totalSeconds
                    };
                });

                applyFiltersAndRender();

            } catch (err) {
                console.error(err);
                alert("Error during analysis. Please check your API Key quota.");
                els.videoGrid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">Error encountered.</p>`;
                els.resultCount.textContent = "";
            }
        };

        function applyFiltersAndRender() {
            let filtered = [...state.videos];
            const now = new Date();

            // Duration
            if (state.filters.duration === 'short') filtered = filtered.filter(v => v.durationSeconds < 120);
            else if (state.filters.duration === 'long') filtered = filtered.filter(v => v.durationSeconds >= 120);

            // Date
            if (state.filters.date !== 'all') {
                filtered = filtered.filter(v => {
                    const days = (now - new Date(v.publishedAt)) / (1000 * 60 * 60 * 24);
                    if (state.filters.date === '1m') return days <= 30;
                    if (state.filters.date === '1y') return days <= 365;
                    if (state.filters.date === '5y') return days <= 365 * 5;
                    return true;
                });
            }

            // Score Filter
            if (state.filters.score !== 'all') {
                filtered = filtered.filter(v => {
                    const s = parseFloat(v.score);
                    if (state.filters.score === 'low') return s < 10;
                    if (state.filters.score === 'mid') return s >= 10 && s < 50;
                    if (state.filters.score === 'high') return s >= 50 && s < 150;
                    if (state.filters.score === 'very_high') return s >= 150;
                    return true;
                });
            }

            // Sort
            filtered.sort((a, b) => {
                if (state.sortBy === 'score_desc') return b.score - a.score;
                if (state.sortBy === 'views_desc') return b.views - a.views;
                if (state.sortBy === 'date_desc') return new Date(b.publishedAt) - new Date(a.publishedAt);
                return 0;
            });

            state.filteredVideos = filtered;
            els.resultCount.textContent = `(${filtered.length} found)`;

            const t = I18N[state.lang];
            els.videoGrid.innerHTML = '';

            if (filtered.length === 0) {
                els.videoGrid.innerHTML = '<p class="col-span-full text-center py-10 text-slate-500">No videos match filters.</p>';
                return;
            }

            filtered.forEach(video => {
                let badgeColor = 'bg-slate-600';
                const s = parseFloat(video.score);
                if (s >= 150) badgeColor = 'bg-yt-red';
                else if (s >= 50) badgeColor = 'bg-green-600';
                else if (s >= 10) badgeColor = 'bg-yellow-500';

                const article = document.createElement('article');
                article.className = "group relative flex flex-col overflow-hidden rounded-xl bg-white dark:bg-surface-dark shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 hover:shadow-md transition-shadow";
                article.innerHTML = `
                    <div class="relative aspect-video w-full overflow-hidden bg-slate-200 cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                        <img alt="${video.title}" class="h-full w-full object-cover group-hover:scale-105 transition-transform duration-500" src="${video.thumbnail}" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60"></div>
                        <span class="absolute bottom-2 right-2 rounded bg-black/80 px-1.5 py-0.5 text-xs font-bold text-white">${video.duration}</span>
                         <span class="absolute top-2 left-2 flex items-center gap-1 rounded ${badgeColor} px-2 py-1 text-xs font-bold text-white shadow-sm">
                            <span class="material-symbols-outlined text-[14px]">trending_up</span>
                            ${video.score}%
                        </span>
                    </div>
                    <div class="flex flex-1 flex-col p-4">
                        <h3 class="text-base font-bold leading-tight text-slate-900 dark:text-white line-clamp-2 mb-2 group-hover:text-primary transition-colors cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                            ${video.title}
                        </h3>
                        <div class="mt-auto flex items-start gap-3">
                             <div class="flex flex-col text-xs text-slate-500 dark:text-slate-400 w-full">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium text-slate-900 dark:text-slate-200 truncate pr-2">${video.channelTitle}</span>
                                    <span>${formatNumber(video.subscribers)} ${t.subs}</span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-400">
                                    <span>${formatNumber(video.views)} ${t.views}</span>
                                    <span>•</span>
                                    <span>${timeAgo(video.publishedAt)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                els.videoGrid.appendChild(article);
            });
        }

        // Run
        init();

    </script>
</body>

</html>