<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Insight Dashboard</title>
    <link href="./dist/output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body
    class="bg-gray-100 dark:bg-zinc-900 text-gray-800 dark:text-gray-200 transition-colors duration-300 font-sans h-screen flex overflow-hidden">

    <aside
        class="w-64 bg-white dark:bg-zinc-800 border-r dark:border-zinc-700 flex flex-col shadow-lg z-20 hidden md:flex transition-all"
        id="sidebar">
        <div class="p-6 border-b dark:border-zinc-700 flex items-center gap-3">
            <i class="fa-brands fa-youtube text-red-600 text-2xl"></i>
            <h1 class="font-bold text-xl tracking-tight">YT Insight</h1>
        </div>

        <div class="p-4">
            <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
                <i class="fa-solid fa-clock-rotate-left mr-1"></i> ê²€ìƒ‰ íˆìŠ¤í† ë¦¬
            </h2>
            <ul id="historyList" class="space-y-2 overflow-y-auto max-h-[70vh]">
                <li class="text-sm text-gray-400 text-center py-4">ê¸°ë¡ ì—†ìŒ</li>
            </ul>
            <button onclick="clearHistory()"
                class="mt-4 w-full text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400 underline text-right">
                ê¸°ë¡ ì „ì²´ ì‚­ì œ
            </button>
        </div>

        <div class="mt-auto p-4 border-t dark:border-zinc-700">
            <button onclick="resetApiKey()"
                class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-800 dark:hover:text-white transition-colors">
                <i class="fa-solid fa-key"></i> API Key ì¬ì„¤ì •
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">

        <header class="bg-white dark:bg-zinc-800 border-b dark:border-zinc-700 p-4 md:p-6 shadow-sm z-10">
            <div class="max-w-7xl mx-auto w-full flex flex-col md:flex-row gap-4 justify-between items-center">
                <button class="md:hidden absolute left-4 top-6 text-xl" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>

                <div class="w-full md:w-1/2 relative ml-8 md:ml-0">
                    <input type="text" id="searchInput" placeholder="ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ì·¨ì—…)"
                        class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 dark:border-zinc-600 bg-gray-50 dark:bg-zinc-700 focus:ring-2 focus:ring-red-500 focus:outline-none transition-all"
                        onkeypress="handleEnter(event)">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-gray-400"></i>
                    <button onclick="performSearch()"
                        class="absolute right-2 top-2 bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-lg text-sm transition-colors">
                        ë¶„ì„
                    </button>
                </div>

                <div class="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                    <select id="durationFilter" onchange="applyFilters()"
                        class="px-3 py-2 rounded-lg border dark:border-zinc-600 bg-white dark:bg-zinc-700 text-sm focus:outline-none">
                        <option value="all">ëª¨ë“  ê¸¸ì´</option>
                        <option value="short">âš¡ ìˆí¼ (2ë¶„ ë¯¸ë§Œ)</option>
                        <option value="long">ğŸ“º ë¡±í¼ (2ë¶„ ì´ìƒ)</option>
                    </select>
                    <select id="dateFilter" onchange="applyFilters()"
                        class="px-3 py-2 rounded-lg border dark:border-zinc-600 bg-white dark:bg-zinc-700 text-sm focus:outline-none">
                        <option value="all">ì „ì²´ ê¸°ê°„</option>
                        <option value="1m">ìµœê·¼ 1ê°œì›”</option>
                        <option value="3m">ìµœê·¼ 3ê°œì›”</option>
                        <option value="6m">ìµœê·¼ 6ê°œì›”</option>
                        <option value="1y">ìµœê·¼ 1ë…„</option>
                    </select>
                    <select id="sortOrder" onchange="applyFilters()"
                        class="px-3 py-2 rounded-lg border dark:border-zinc-600 bg-white dark:bg-zinc-700 text-sm focus:outline-none font-bold text-red-600 dark:text-red-400">
                        <option value="relevance">ê¸°ë³¸ ì •ë ¬</option>
                        <option value="revenue">ğŸ’° ìˆ˜ìµ ë†’ì€ìˆœ</option>
                        <option value="views">ğŸ‘ï¸ ì¡°íšŒìˆ˜ ë†’ì€ìˆœ</option>
                    </select>
                </div>
            </div>
        </header>

        <div id="resultsArea" class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-100 dark:bg-zinc-900">
            <div id="loader" class="hidden flex-col items-center justify-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
                <p class="mt-4 text-gray-500 animate-pulse">ë°ì´í„° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <div id="emptyState" class="flex flex-col items-center justify-center h-64 text-gray-400">
                <i class="fa-solid fa-chart-line text-6xl mb-4 opacity-20"></i>
                <p>í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•˜ì—¬ ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>

            <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
            </div>
        </div>
    </main>

    <div id="apiKeyModal"
        class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div
            class="bg-white dark:bg-zinc-800 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 border border-gray-200 dark:border-zinc-700">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white"><i
                    class="fa-brands fa-google text-red-500 mr-2"></i>API ì„¤ì •</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm leading-relaxed">
                YouTube Data API v3 í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
                í‚¤ëŠ” ë¸Œë¼ìš°ì € <span class="font-mono bg-gray-200 dark:bg-zinc-700 px-1 rounded">localStorage</span>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
            <input type="password" id="apiKeyInput" placeholder="AIzaSy..."
                class="w-full px-4 py-3 rounded-lg border dark:border-zinc-600 bg-gray-50 dark:bg-zinc-700 mb-4 focus:ring-2 focus:ring-red-500 focus:outline-none dark:text-white">
            <button onclick="saveApiKey()"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-transform active:scale-95 shadow-lg">
                ì‹œì‘í•˜ê¸°
            </button>
            <p class="mt-4 text-xs text-center text-gray-400">
                <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                    class="underline hover:text-red-500">Google Cloud Consoleì—ì„œ í‚¤ ë°œê¸‰ë°›ê¸°</a>
            </p>
        </div>
    </div>

    <script>
        // --- Global State ---
        let YOUTUBE_API_KEY = localStorage.getItem('yt_api_key');
        let currentData = []; // í˜„ì¬ ë¡œë“œëœ ì›ë³¸ ë°ì´í„° (í•„í„°ë§ ì „)
        const CPM = 2; // $2 per 1000 views

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!YOUTUBE_API_KEY) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
            }
            renderHistory();
        });

        // --- 1. API Management ---
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) return alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            localStorage.setItem('yt_api_key', key);
            YOUTUBE_API_KEY = key;
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        function resetApiKey() {
            localStorage.removeItem('yt_api_key');
            location.reload();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') performSearch();
        }

        // --- 2. Core Logic: Search & Analyze ---
        async function performSearch(keyword = null) {
            const query = keyword || document.getElementById('searchInput').value.trim();
            if (!query) return;

            // UI Reset
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsGrid').innerHTML = '';

            // Sidebar collapse on mobile
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');

            try {
                // Step 1: Search Endpoint (Get Video IDs)
                const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=30&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
                const searchRes = await fetch(searchUrl);

                if (!searchRes.ok) throw new Error(searchRes.status);
                const searchData = await searchRes.json();

                if (searchData.items.length === 0) {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('loader').classList.add('hidden');
                    return;
                }

                // Collect IDs
                const videoIds = searchData.items.map(item => item.id.videoId).join(',');
                const channelIds = [...new Set(searchData.items.map(item => item.snippet.channelId))].join(',');

                // Step 2 & 3: Parallel Fetch (Videos Details & Channel Stats)
                const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics,snippet&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelIds}&key=${YOUTUBE_API_KEY}`;

                const [videoRes, channelRes] = await Promise.all([
                    fetch(videoDetailsUrl),
                    fetch(channelsUrl)
                ]);

                const videoDetails = await videoRes.json();
                const channelDetails = await channelRes.json();

                // Create Channel Map for fast lookup
                const channelMap = {};
                channelDetails.items.forEach(ch => {
                    channelMap[ch.id] = ch.statistics.subscriberCount;
                });

                // Step 4: Merge Data
                currentData = videoDetails.items.map(vid => {
                    const subs = channelMap[vid.snippet.channelId] || 0;
                    const views = vid.statistics.viewCount || 0;
                    const durationSec = parseDuration(vid.contentDetails.duration);

                    return {
                        id: vid.id,
                        title: vid.snippet.title,
                        thumbnail: vid.snippet.thumbnails.medium.url,
                        channelTitle: vid.snippet.channelTitle,
                        publishedAt: new Date(vid.snippet.publishedAt),
                        viewCount: parseInt(views),
                        likeCount: parseInt(vid.statistics.likeCount || 0),
                        subscriberCount: parseInt(subs),
                        duration: durationSec, // seconds
                        tags: vid.snippet.tags || [],
                        // Analysis Metrics
                        vpRatio: subs > 0 ? (views / subs) * 100 : 0,
                        estRevenue: (views / 1000) * CPM
                    };
                });

                // Save to History (Full JSON cache)
                addToHistory(query, currentData);

                // Render
                applyFilters();

            } catch (error) {
                console.error(error);
                if (error.message == '403') {
                    alert('API í‚¤ ì˜¤ë¥˜ ë˜ëŠ” í• ë‹¹ëŸ‰ ì´ˆê³¼ì…ë‹ˆë‹¤. í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                    resetApiKey();
                } else {
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // --- 3. Parsing & Calculating Utils ---

        // ISO 8601 Duration Parser (PT1H2M10S -> Seconds)
        function parseDuration(duration) {
            if (!duration) return 0;
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!match) return 0;

            const hours = (parseInt(match[1]) || 0);
            const minutes = (parseInt(match[2]) || 0);
            const seconds = (parseInt(match[3]) || 0);
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR', { notation: "compact", maximumFractionDigits: 1 }).format(num);
        }

        function getDaysSince(date) {
            const now = new Date();
            const diff = now - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function getVpBadge(ratio) {
            let grade = 'D';
            let color = 'bg-gray-500';

            if (ratio >= 100) { grade = 'S'; color = 'bg-purple-600'; } // Viral
            else if (ratio >= 50) { grade = 'A'; color = 'bg-green-600'; }
            else if (ratio >= 30) { grade = 'B'; color = 'bg-blue-600'; }
            else if (ratio >= 10) { grade = 'C'; color = 'bg-yellow-500 text-black'; }

            return `<span class="${color} text-white text-xs font-bold px-2 py-1 rounded shadow-sm" title="êµ¬ë…ì ëŒ€ë¹„ ì¡°íšŒìˆ˜ ${ratio.toFixed(1)}%">VP ${grade}ë“±ê¸‰</span>`;
        }

        // --- 4. Filtering & Rendering ---

        function applyFilters() {
            const durFilter = document.getElementById('durationFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            let filtered = currentData.filter(item => {
                // Duration Filter
                if (durFilter === 'short' && item.duration >= 120) return false;
                if (durFilter === 'long' && item.duration < 120) return false;

                // Date Filter
                const daysAgo = getDaysSince(item.publishedAt);
                if (dateFilter === '1m' && daysAgo > 30) return false;
                if (dateFilter === '3m' && daysAgo > 90) return false;
                if (dateFilter === '6m' && daysAgo > 180) return false;
                if (dateFilter === '1y' && daysAgo > 365) return false;

                return true;
            });

            // Sorting
            if (sortOrder === 'revenue') {
                filtered.sort((a, b) => b.estRevenue - a.estRevenue);
            } else if (sortOrder === 'views') {
                filtered.sort((a, b) => b.viewCount - a.viewCount);
            }

            renderResults(filtered);
        }

        function renderResults(data) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';

            if (data.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            data.forEach(item => {
                const daysAgo = getDaysSince(item.publishedAt);
                const revenue = item.estRevenue.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                const ratio = item.vpRatio.toFixed(1);

                // Format Duration
                const min = Math.floor(item.duration / 60);
                const sec = item.duration % 60;
                const durStr = `${min}:${sec.toString().padStart(2, '0')}`;

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-zinc-800 rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 dark:border-zinc-700 overflow-hidden flex flex-col";

                card.innerHTML = `
                    <div class="relative group cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${item.id}', '_blank')">
                        <img src="${item.thumbnail}" alt="thumb" class="w-full h-48 object-cover">
                        <span class="absolute bottom-2 right-2 bg-black bg-opacity-80 text-white text-xs px-2 py-1 rounded">${durStr}</span>
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all flex items-center justify-center">
                            <i class="fa-solid fa-play text-white text-4xl opacity-0 group-hover:opacity-100 drop-shadow-lg transition-opacity"></i>
                        </div>
                    </div>
                    
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            ${getVpBadge(item.vpRatio)}
                            <span class="text-xs text-green-600 dark:text-green-400 font-bold bg-green-50 dark:bg-green-900/30 px-2 py-1 rounded border border-green-200 dark:border-green-800">
                                ${revenue} (est.)
                            </span>
                        </div>

                        <h3 class="font-bold text-gray-800 dark:text-white mb-1 line-clamp-2 leading-snug h-12" title="${item.title}">
                            ${item.title}
                        </h3>
                        
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-user-circle"></i> ${item.channelTitle} 
                            <span class="mx-1">â€¢</span> êµ¬ë…ì ${formatNumber(item.subscriberCount)}
                        </div>

                        <div class="grid grid-cols-3 gap-2 text-center bg-gray-50 dark:bg-zinc-700/50 rounded-lg p-2 mt-auto">
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase">ì¡°íšŒìˆ˜</p>
                                <p class="font-bold text-sm dark:text-gray-200">${formatNumber(item.viewCount)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase">ì¢‹ì•„ìš”</p>
                                <p class="font-bold text-sm dark:text-gray-200">${formatNumber(item.likeCount)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase">ê²½ê³¼ì¼</p>
                                <p class="font-bold text-sm dark:text-gray-200">${daysAgo}ì¼</p>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 5. History Management ---
        function addToHistory(keyword, data) {
            let history = JSON.parse(localStorage.getItem('yt_history') || '[]');
            // ì¤‘ë³µ ì œê±° ë° ìµœì‹ í™”
            history = history.filter(h => h.keyword !== keyword);
            history.unshift({ keyword, data, timestamp: new Date().toISOString() });

            // ìµœëŒ€ 10ê°œ ì €ì¥ (ìš©ëŸ‰ ê´€ë¦¬)
            if (history.length > 10) history.pop();

            localStorage.setItem('yt_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('yt_history') || '[]');

            list.innerHTML = '';
            if (history.length === 0) {
                list.innerHTML = '<li class="text-sm text-gray-400 text-center py-4">ê¸°ë¡ ì—†ìŒ</li>';
                return;
            }

            history.forEach(item => {
                const li = document.createElement('li');
                li.className = "group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors";
                li.onclick = () => loadHistoryItem(item);
                li.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-500 shrink-0">
                            <i class="fa-solid fa-magnifying-glass text-xs"></i>
                        </div>
                        <span class="text-sm font-medium dark:text-gray-300 truncate">${item.keyword}</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-xs text-gray-300 group-hover:text-gray-500"></i>
                `;
                list.appendChild(li);
            });
        }

        function loadHistoryItem(item) {
            document.getElementById('searchInput').value = item.keyword;
            currentData = item.data; // ì €ì¥ëœ ë°ì´í„° ë³µì›

            // ë°ì´í„° ë‚´ ë‚ ì§œ ê°ì²´ ë³µì› (JSON ì§ë ¬í™”ë¡œ ë¬¸ìì—´ë¨)
            currentData.forEach(d => d.publishedAt = new Date(d.publishedAt));

            document.getElementById('emptyState').classList.add('hidden');
            applyFilters(); // í•„í„° ì ìš©í•˜ì—¬ ë Œë”ë§

            // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë‹«ê¸°
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
        }

        function clearHistory() {
            if (confirm('ëª¨ë“  ê²€ìƒ‰ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('yt_history');
                renderHistory();
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden');
            sb.classList.toggle('absolute');
            sb.classList.toggle('h-full');
        }
    </script>
</body>

</html>